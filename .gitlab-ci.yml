image: node:10

before_script:
    # setting unsafe-perm and shell config is needed to get the mattermost-redux
    # dependency correctly installed BECAUSE it is a git url w/ a prepare script
    # AND the node image user is root! npm acts differently when run as root!
    - npm config set unsafe-perm true
    - npm config set shell /bin/bash

check-style:
    stage: test
    script:
        - make check-style-ci
    allow_failure: true
    artifacts:
        when: always
        paths:
            - build/check-style.log
    only:
        - merge_requests
        - tags
        - /gitlab/

test:
    stage: test
    script:
        - make test-ci
        - tail --lines=14 build/test.log
    allow_failure: true
    artifacts:
        when: always
        paths:
            - build/test.log
            - build/test-results.xml
    only:
        - merge_requests
        - tags
        - /gitlab/

build:
    stage: test     # test rather than build, as it doesn't need to complete before testing
    script:
        - make build > build/build.log
    artifacts:
        when: always
        paths:
            - build/build.log
    only:
        - merge_requests
        - tags
        - /gitlab/
